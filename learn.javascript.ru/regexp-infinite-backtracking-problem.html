<!DOCTYPE html><html lang="ru"><head><script>window.currentUser = null;</script><script>window.rateUsdToNative = 65.69;</script><title itemprop="name">Чёрная дыра бэктрекинга</title><link href="pack/styles.ce210dd933f17ce8be6f.css" rel="stylesheet"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, minimum-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><!-- chrome autotranslate is enabled only for "en" main version--><meta name="google" content="notranslate"><script>if (window.devicePixelRatio > 1) document.cookie = 'pixelRatio=' + window.devicePixelRatio + ';path=/;expires=Tue, 19 Jan 2038 03:14:07 GMT';</script><link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700%7COpen+Sans+Condensed:700&amp;subset=latin,latin-ext,cyrillic,cyrillic-ext" rel="stylesheet"><link rel="apple-touch-icon-precomposed" href="img/favicon/apple-touch-icon-precomposed.png"><link rel="canonical" href="https://learn.javascript.ru/regexp-infinite-backtracking-problem"><meta name="msapplication-TileColor" content="#222A2C"><meta name="msapplication-TileImage" content="/img/favicon/tileicon.png"><link rel="icon" href="img/favicon/favicon.png"><meta itemprop="image" content="https://learn.javascript.ru/img/site_preview_ru_512x512.png"><meta property="og:title" content="Чёрная дыра бэктрекинга"><meta property="og:image" content="https://learn.javascript.ru/img/site_preview_ru_1200x630.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="fb:admins" content="100001562528165"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Чёрная дыра бэктрекинга"><meta name="twitter:site" content="@iliakan"><meta name="twitter:creator" content="@iliakan"><meta name="twitter:image" content="https://learn.javascript.ru/img/site_preview_ru_512x512.png"><link rel="prev" href="regexp-lookahead.html"><link rel="next" href="extra.html"><script>window.GA_ID = "UA-2056213-16";</script><script>window.GTM_ID = 'GTM-WD2DZPG'</script><script>window.YANDEX_METRIKA_ID = 17649010;</script><script>window.GoogleAnalyticsObject="ga",window.ga=function(){window.ga.q.push(arguments)},window.ga.q=[],window.ga.l=Date.now(),ga("create",GA_ID,"auto"),window.GTM_ID&&ga("require",GTM_ID),window.currentUser?ga("set","&uid",currentUser.id):ga("set","anonymizeIp",!0),window.addEventListener("error",function(e){var r=(e.filename||e.errorUrl)+": "+(e.lineno||e.errorLine),n=e.stack||e.error&&e.error.stack;ga("send","exception",{exDescription:e.message+" "+r+" "+n,exFatal:!0})});</script><script src="https://www.google-analytics.com/analytics.js" async></script><script>ga('send', 'pageview');</script><script>window.metrika={reachGoal:function(){}},window.yandex_metrika_callbacks=[function(){try{window.metrika=new Ya.Metrika({id:YANDEX_METRIKA_ID,webvisor:!0,clickmap:!0,params:{user:window.currentUser&&window.currentUser.id}}),metrika.trackLinks({delay:150}),window.addEventListener("error",function(r){window.metrika.reachGoal("JSERROR",{src:(r.filename||r.errorUrl)+": "+(r.lineno||r.errorLine),stack:r.stack||r.error&&r.error.stack,message:r.message})})}catch(r){}}];</script><script src="http://mc.yandex.ru/metrika/watch.js" async></script><script>window.RECAPTCHA_ID = "6Lf9NyETAAAAACZlg-a9Us2SxvYbeVC1ROWaWv4O";</script><script src="pack/init.ce210dd933f17ce8be6f.js"></script><script src="pack/head.ce210dd933f17ce8be6f.js" defer></script><meta property="og:title" content="Чёрная дыра бэктрекинга"><meta property="og:type" content="article"><script src="pack/tutorial.ce210dd933f17ce8be6f.js" defer></script><script src="pack/footer.ce210dd933f17ce8be6f.js" defer></script></head><body class="no-icons"><script>window.fontTest();</script><div class="page-wrapper page-wrapper_sidebar_on"><!--[if lt IE 10]><div style="color:red;text-align:center">Извините, IE&lt;10 не поддерживается, пожалуйста используйте более новый браузер.</div><![endif]--><div class="sitetoolbar sitetoolbar_tutorial"><div class="sitetoolbar__content"><div class="sitetoolbar__logo-wrap"><a class="sitetoolbar__link sitetoolbar__link_logo" href="index.html"><img class="sitetoolbar__logo sitetoolbar__logo_normal" src="img/sitetoolbar__logo_ru.svg" width="171" alt="" role="presentation"/><img class="sitetoolbar__logo sitetoolbar__logo_small" src="img/sitetoolbar__logo_small_ru.svg" width="80" alt="" role="presentation"/><script>Array.prototype.forEach.call(document.querySelectorAll("img.sitetoolbar__logo"),function(e){let t=document.createElement("object");t.type="image/svg+xml",t.className=e.className,t.style.cssText="left:0;top:0;position:absolute",t.onload=function(){t.onload=null,e.style.visibility="hidden"},t.data=e.src,e.parentNode.insertBefore(t,e)});</script></a></div><div class="sitetoolbar__nav-toggle-wrap"><button class="sitetoolbar__nav-toggle" type="button"></button></div><nav class="sitetoolbar__sections"><ul class="sitetoolbar__sections-list"><li class="sitetoolbar__section sitetoolbar__section_current"><a class="sitetoolbar__link" href="index.html">Учебник</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="courses.1.html">Курсы</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="https://javascript.ru/forum/">Форум</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="https://es5.javascript.ru">ES5</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="quiz.html">Тесты знаний</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="jobs.1.html">Стажировки</a></li><li class="sitetoolbar__section sitetoolbar__section_dropdown"><button class="sitetoolbar__dropdown-button" data-dropdown-toggler>Скринкасты</button><div class="sitetoolbar__dropdown-wrap"><div class="sitetoolbar__dropdown-body"><ul class="sitetoolbar__dropdown-items"><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="nodejs-screencast.html">Node.js</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="screencast/webpack.html">Webpack</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="screencast/gulp.html">Gulp 4</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="screencast/react.html">React.js</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="screencast/angular.html">Angular</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="screencast/git.html">Git</a></li></ul></div></div></li></ul></nav><div class="sitetoolbar__book-wrap"><a class="buy-book-button" href="ebook.1.html"><span class="buy-book-button__extra-text">Купить</span>EPUB/PDF</a></div><div class="sitetoolbar__login-wrap"><button class="sitetoolbar__login sitetoolbar__login_unready" data-action-login></button></div><div class="sitetoolbar__search-wrap"><div class="sitetoolbar__search-content"><form class="sitetoolbar__search" method="GET" action="http://learn.javascript.ru/search"><button class="sitetoolbar__search-toggle" type="button"></button><div class="sitetoolbar__search-input"><div class="text-input"><input class="text-input__control" autofocus="autofocus" name="query" placeholder="Искать на Javascript.ru" type="text"/></div><button class="sitetoolbar__find" type="submit">Найти</button></div></form></div></div></div><div class="tablet-menu"><div class="tablet-menu__line"><div class="tablet-menu__content"><select class="tablet-menu__nav input-select input-select input-select_small" onchange="if(this.value) window.location.href=this.value"><option value="/" selected>Учебник</option><option value="/courses">Курсы</option><option value="https://javascript.ru/forum/">Форум</option><option value="https://es5.javascript.ru">ES5</option><option value="/quiz">Тесты знаний</option><option value="/jobs">Стажировки</option></select></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><form class="tablet-menu-search" action="http://learn.javascript.ru/search/"><input class="tablet-menu-search__input" type="search" name="query" placeholder="Поиск в учебнике" required="required"/><button class="tablet-menu-search__button" type="submit" name="type" value="articles">Поиск</button></form></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><a class="map" href="tutorial/map.html" data-action="tutorial-map"><span class="map__text">Карта учебника</span></a></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><div class="share-icons"><span class="share-icons__title">Поделиться</span><a class="share share_tw" href="https://twitter.com/share?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_fb" href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_gp" href="https://plus.google.com/share?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_vk" href="https://vkontakte.ru/share.php?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a></div></div></div></div><progress class="tutorial-progress" data-sticky value="13" max="13" data-tooltip="Урок 13 из 13"></progress></div><div class="page page_sidebar_on page_inner_padding"><script>if(localStorage.noSidebar){document.querySelector(".page").classList.remove("page_sidebar_on");var pageWrapper=document.querySelector(".page-wrapper");pageWrapper&&pageWrapper.classList.remove("page-wrapper_sidebar_on")}setTimeout(function(){document.querySelector(".page").classList.add("page_sidebar-animation-on")},0);</script><div class="page__inner"><main class="main main_width-limit"><header class="main__header"><div class="main__header-inner"><ol class="breadcrumbs"><li class="breadcrumbs__item breadcrumbs__item_home" itemscope itemtype="http://data-vocabulary.org/Breadcrumb" itemref="breadcrumb-1"><a class="breadcrumbs__link" href="index.html" itemprop="url"><span class="breadcrumbs__hidden-text" itemprop="title">Учебник</span></a></li><li class="breadcrumbs__item" id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb" itemprop="child"><a class="breadcrumbs__link" href="regular-expressions-javascript.html" itemprop="url"><span itemprop="title">Регулярные выражения</span></a></li></ol><h1 class="main__header-title">Чёрная дыра бэктрекинга</h1></div></header><div class="content"><article class="formatted" itemscope itemtype="http://schema.org/TechArticle"><meta itemprop="name" content="Чёрная дыра бэктрекинга"><div itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="email" content="iliakan@gmail.com"><meta itemprop="name" content="Ilya Kantor"></div><div itemprop="articleBody"><p>Некоторые регулярные выражения, с виду являясь простыми, могут выполняться оооочень долго, и даже «подвешивать» интерпретатор JavaScript.</p>
<p>Рано или поздно, с этим сталкивается любой разработчик, потому что нечаянно создать такое регулярное выражение – легче лёгкого.</p>
<p>Типична ситуация, когда регулярное выражение до поры до времени работает нормально, и вдруг на каком-то тексте как начнёт «подвешивать» интерпретатор и есть 100% процессора.</p>
<p>Это может стать уязвимостью. Например, если JavaScript выполняется на сервере, то при разборе данных, присланных посетителем, он может зависнуть, если использует подобный регэксп. На клиенте тоже возможно подобное, при использовании регэкспа для подсветки синтаксиса.</p>
<p>Такие уязвимости «убивали» почтовые сервера и системы обмена сообщениями и до появления JavaScript, и наверно будут «убивать» и после его исчезновения. Так что мы просто обязаны с ними разобраться.</p>
<h2><a class="main__anchor" name="primer" href="regexp-infinite-backtracking-problem.html#primer">Пример</a></h2><p>План изложения у нас будет таким:</p>
<ol>
<li>Сначала посмотрим на проблему в реальной ситуации.</li>
<li>Потом упростим реальную ситуацию до «корней» и увидим, откуда она берётся.</li>
</ol>
<p>Рассмотрим, например, поиск по HTML.</p>
<p>Мы хотим найти теги с атрибутами, то есть совпадения вида <code class="subject">&lt;a href=&quot;...&quot; class=doc ...&gt;</code>.</p>
<p>Самый простой способ это сделать – <code class="pattern">&lt;[^&gt;]*&gt;</code>. Но он же и не совсем корректный, так как тег может выглядеть так: <code class="subject">&lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;</code>. То есть, внутри «закавыченного» атрибута может быть символ <code>&gt;</code>. Простейший регэксп на нём остановится и найдёт <code class="match">&lt;a test=&quot;&lt;&gt;</code>.</p>
<p>Соответствие:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">&lt;[^&gt;]*....&gt;
&lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;</code></pre>
        </div>
      </div>
      
      </div><p>А нам нужен весь тег.</p>
<p>Для того, чтобы правильно обрабатывать такие ситуации, нужно учесть их в регулярном выражении. Оно будет иметь вид <code class="pattern">&lt;тег (ключ=значение)*&gt;</code>.</p>
<p>Если перевести на язык регэкспов, то: <code class="pattern">&lt;\w+(\s*\w+=(\w+|&quot;[^&quot;]*&quot;)\s*)*&gt;</code>:</p>
<ol>
<li><code class="pattern">&lt;\w+</code> – начало тега</li>
<li><code class="pattern">(\s*\w+=(\w+|&quot;[^&quot;]*&quot;)\s*)*</code> – произвольное количество пар вида <code>слово=значение</code>, где «значение» может быть также словом <code class="pattern">\w+</code>, либо строкой в кавычках <code class="pattern">&quot;[^&quot;]*&quot;</code>.</li>
</ol>
<p>Мы пока не учитываем все детали грамматики HTML, ведь строки возможны и в „одинарных“ кавычках, но на данный момент этого достаточно. Главное, что регулярное выражение получилось в меру простым и понятным.</p>
<p>Испытаем полученный регэксп в действии:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code class="language-javascript">var reg = /&lt;\w+(\s*\w+=(\w+|&quot;[^&quot;]*&quot;)\s*)*&gt;/g;

var str='...&lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;... &lt;b&gt;...';

alert( str.match(reg) ); // &lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;, &lt;b&gt;</code></pre>
        </div>
      </div>
      
      </div><p>Отлично, всё работает! Нашло как длинный тег <code class="match">&lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;</code>, так и одинокий <code class="match">&lt;b&gt;</code>.</p>
<p>А теперь – демонстрация проблемы.</p>
<p>Если запустить пример ниже, то он может подвесить браузер:</p>
<div data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:5,&quot;end&quot;:6}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code class="language-javascript">var reg = /&lt;\w+(\s*\w+=(\w+|&quot;[^&quot;]*&quot;)\s*)*&gt;/g;

var str = &quot;&lt;tag a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  \
a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b&quot;;

// Этот поиск будет выполняться очень, очень долго
alert( str.match(reg) );</code></pre>
        </div>
      </div>
      
      </div><p>Некоторые движки регулярных выражений могут в разумное время разобраться с таким поиском, но большинство – нет.</p>
<p>В чём дело? Почему несложное регулярное выражение на такой небольшой строке «виснет» наглухо?</p>
<p>Упростим ситуацию, удалив тег и возможность указывать строки в кавычках:</p>
<div data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:6,&quot;end&quot;:7}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code class="language-javascript">// только атрибуты, разделённые пробелами
var reg = /&lt;(\s*\w+=\w+\s*)*&gt;/g;

var str = &quot;&lt;a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  \
a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b&quot;;

// Этот поиск будет выполняться очень, очень долго
alert( str.match(reg) );</code></pre>
        </div>
      </div>
      
      </div><p>То же самое.</p>
<p>На этом мы закончим с демонстрацией «практического примера» и перейдём к разбору происходящего.</p>
<h2><a class="main__anchor" name="bektreking" href="regexp-infinite-backtracking-problem.html#bektreking">Бектрекинг</a></h2><p>В качестве ещё более простого регулярного выражения, рассмотрим <code class="pattern">(\d+)*$</code>.</p>
<p>В большинстве движков регэкспов, например в Chrome или IE, этот поиск выполняется очень долго (осторожно, может «подвесить» браузер):</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code class="language-javascript">alert( '12345678901234567890123456789123456789z'.match(/(\d+)*$/) );</code></pre>
        </div>
      </div>
      
      </div><p>В чём же дело, что не так с регэкспом?</p>
<p>Внимательный читатель, посмотрев на него, наверняка удивится, ведь он «какой-то странный». Квантификатор <code class="pattern">*</code> здесь выглядит лишним.</p>
<p>Если хочется найти число, то с тем же успехом можно искать <code class="pattern">\d+$</code>.</p>
<p>Да, этот регэксп носит искусственный характер, но, разобравшись с ним, мы поймём и практический пример, данный выше. Причина их медленной работы одинакова.</p>
<p>В целом, с регэкспом «всё так», синтаксис вполне допустимый. Проблема в том, как выполняется поиск по нему.</p>
<p>Посмотрим, что происходит при поиске в строке <code class="subject">123456789z</code>:</p>
<ol>
<li>
<p>Первым делом, движок регэкспов пытается найти <code class="pattern">\d+</code>. Плюс <code class="pattern">+</code> является жадным по умолчанию, так что он хватает все цифры, какие может:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">\d+.......
(123456789)z</code></pre>
        </div>
      </div>
      
      </div></li>
<li>
<p>Затем движок пытается применить звёздочку вокруг скобок <code class="pattern">(\d+)*</code>, но больше цифр нет, так что звёздочка не даёт повторений.</p>
<p>Затем в шаблоне идёт символ конца строки <code class="pattern">$</code>, а в тексте – символ <code class="subject">z</code>.</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">           X
\d+........$
(123456789)z</code></pre>
        </div>
      </div>
      
      </div><p>Соответствия нет.</p>
</li>
<li>
<p>Так как соответствие не найдено, то «жадный» плюс <code class="pattern">+</code> отступает на один символ (бэктрекинг).</p>
<p>Теперь <code>\d+</code> – это все цифры, за исключением последней:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">\d+.......
(12345678)9z</code></pre>
        </div>
      </div>
      
      </div></li>
<li>
<p>После бэктрекинга, <code class="pattern">\d+</code> содержит всё число, кроме последней цифры. Движок снова пытается найти совпадение, уже с новой позиции (<code>9</code>).</p>
<p>Звёздочка <code class="pattern">(\d+)*</code> теперь может быть применена – она даёт число <code class="match">9</code>:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">\d+.......\d+
(12345678)(9)z</code></pre>
        </div>
      </div>
      
      </div><p>Движок пытается найти <code>$</code>, но это ему не удаётся – на его пути опять <code>z</code>:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">             X
\d+.......\d+
(12345678)(9)z</code></pre>
        </div>
      </div>
      
      </div><p>Так как совпадения нет, то поисковой движок отступает назад ещё раз.</p>
</li>
<li>
<p>Теперь первое число <code class="pattern">\d+</code> будет содержать 7 цифр, а остаток строки <code class="subject">89</code> становится вторым <code class="pattern">\d+</code>:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">             X
\d+......\d+
(1234567)(89)z</code></pre>
        </div>
      </div>
      
      </div><p>Увы, всё ещё нет соответствия для <code class="pattern">$</code>.</p>
<p>Поисковой движок снова должен отступить назад. При этом последний жадный квантификатор отпускает символ. В данном случае это означает, что укорачивается второй <code class="pattern">\d+</code>, до одного символа <code class="subject">8</code>, и звёздочка забирает следующий <code class="subject">9</code>.</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">               X
\d+......\d+\d+
(1234567)(8)(9)z</code></pre>
        </div>
      </div>
      
      </div></li>
<li>
<p>…И снова неудача. Второе и третье <code class="pattern">\d+</code> отступили по-максимуму, так что сокращается снова первое число, до <code class="subject">123456</code>, а звёздочка берёт оставшееся:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">             X
\d+.......\d+
(123456)(789)z</code></pre>
        </div>
      </div>
      
      </div><p>Снова нет совпадения. Процесс повторяется, последний жадный квантификатор <code class="pattern">+</code> отпускает один символ (<code>9</code>):</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">               X
\d+.....\d+ \d+
(123456)(78)(9)z</code></pre>
        </div>
      </div>
      
      </div></li>
<li>
<p>…И так далее.</p>
</li>
</ol>
<p>Получается, что движок регулярных выражений перебирает все комбинации из <code>123456789</code> и их подпоследовательности. А таких комбинаций очень много.</p>
<p>На этом месте умный читатель может воскликнуть: «Во всём виноват бэктрекинг? Давайте включим ленивый режим – и не будет никакого бэктрекинга!»</p>
<p>Что ж, заменим <code class="pattern">\d+</code> на <code class="pattern">\d+?</code> и посмотрим (аккуратно, может подвесить браузер):</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code class="language-javascript">alert( '12345678901234567890123456789123456789z'.match(/(\d+?)*$/) );</code></pre>
        </div>
      </div>
      
      </div><p>Не помогло!</p>
<p><strong>Ленивые регулярные выражения делают то же самое, но в обратном порядке.</strong></p>
<p>Просто подумайте о том, как будет в этом случае работать поисковой движок.</p>
<p>Некоторые движки регулярных выражений содержат хитрые проверки и конечные автоматы, которые позволяют избежать бесконечного перебора или кардинально ускорить его, но не все движки и не всегда.</p>
<p>Возвращаясь к примеру выше – при поиске <code class="pattern">&lt;(\s*\w+=\w+\s*)*&gt;</code> в строке <code class="subject">&lt;a=b a=b a=b a=b</code> происходит то же самое.</p>
<p>Поиск успешно начинается, выбирается некая комбинация из <code class="pattern">\s*\w+=\w+\s*</code>, которая, так как в конце нет <code>&gt;</code>, оказывается не подходящей. Движок честно отступает, пробует другую комбинацию – и так далее.</p>
<h2><a class="main__anchor" name="chto-delat" href="regexp-infinite-backtracking-problem.html#chto-delat">Что делать?</a></h2><p>Проблема – в сверхмноговариантном переборе.</p>
<p>Движок регулярных выражений перебирает кучу возможных вариантов скобок там, где это не нужно.</p>
<p>Например, в регэкспе <code class="pattern">(\d+)*$</code> нам (людям) очевидно, что в <code class="pattern">(\d+)</code> откатываться не нужно. От того, что вместо одного <code class="pattern">\d+</code> у нас два независимых <code class="pattern">\d+\d+</code>, ничего не изменится.</p>
<p>Без разницы:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-none"><code class="language-none">\d+........
(123456789)z

\d+...\d+....
(1234)(56789)z</code></pre>
        </div>
      </div>
      
      </div><p>Если вернуться к более реальному примеру <code class="pattern">&lt;(\s*\w+=\w+\s*)*&gt;</code> то
сам алгоритм поиска, который у нас в голове, предусматривает, что мы «просто» ищем тег, а потом пары <code>атрибут=значение</code> (сколько получится).</p>
<p>Никакого «отката» здесь не нужно.</p>
<p>В современных регулярных выражениях для решения этой проблемы придумали «possessive» (сверхжадные? неоткатные? точный перевод пока не устоялся) квантификаторы, которые вообще не используют бэктрегинг.</p>
<p>То есть, они даже проще, чем «жадные» – берут максимальное количество символов и всё. Поиск продолжается дальше. При несовпадении никакого возврата не происходит.</p>
<p>Это, с одной стороны, уменьшает количество возможных результатов, но, с другой стороны, в ряде случаев очевидно, что возврат (уменьшение количество повторений квантификатора) результата не даст. А только потратит время, что как раз и доставляет проблемы. Как раз такие ситуации и описаны выше.</p>
<p>Есть и другое средство – «атомарные скобочные группы», которые запрещают перебор внутри скобок, по сути позволяя добиваться того же, что и сверхжадные квантификаторы,</p>
<p>К сожалению, в JavaScript они не поддерживаются.</p>
<p>Однако, можно получить подобный эффект при помощи предпросмотра. Подробное описание соответствия с учётом синтаксиса сверхжадных квантификаторов и атомарных групп есть в статьях <a href="http://instanceof.me/post/52245507631/regex-emulate-atomic-grouping-with-lookahead">Regex: Emulate Atomic Grouping (and Possessive Quantifiers) with LookAhead</a> и <a href="http://blog.stevenlevithan.com/archives/mimic-atomic-groups">Mimicking Atomic Groups</a>, здесь же мы останемся в рамках синтаксиса JavaScript.</p>
<p>Взятие максимального количества повторений <code>a+</code> без отката выглядит так: <code class="pattern">(?=(a+))\1</code>.</p>
<p>То есть, иными словами, предпросмотр <code class="pattern">?=</code> ищет максимальное количество повторений <code class="pattern">a+</code>, доступных с текущей позиции. А затем они «берутся в результат» обратной ссылкой <code class="pattern">\1</code>. Дальнейший поиск – после найденных повторений.</p>
<p>Откат в этой логике в принципе не предусмотрен, поскольку предпросмотр «откатываться» не умеет. То есть, если предпросмотр нашёл 5 штук <code class="pattern">a+</code>, и в результате поиск не удался, то он не будет откатываться на 4 повторения. Эта возможность в предпросмотре отсутствует, а в данном случае она как раз и не нужна.</p>
<p>Исправим регэксп для поиска тега с атрибутами <code class="pattern">&lt;\w+(\s*\w+=(\w+|&quot;[^&quot;]*&quot;)\s*)*&gt;</code>, описанный в начале главы. Используем предпросмотр, чтобы запретить откат на меньшее количество пар <code>атрибут=значение</code>:</p>
<div data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="regexp-infinite-backtracking-problem.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code class="language-javascript">// регэксп для пары атрибут=значение
var attr = /(\s*\w+=(\w+|&quot;[^&quot;]*&quot;)\s*)/

// используем его внутри регэкспа для тега
var reg = new RegExp('&lt;\\w+(?=(' + attr.source + '*))\\1&gt;', 'g');

var good = '...&lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;... &lt;b&gt;...';

var bad = &quot;&lt;tag a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b\
  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b  a=b&quot;;

alert( good.match(reg) ); // &lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;, &lt;b&gt;
alert( bad.match(reg) ); // null (нет результатов, быстро)</code></pre>
        </div>
      </div>
      
      </div><p>Отлично, всё работает! Нашло как длинный тег <code class="match">&lt;a test=&quot;&lt;&gt;&quot; href=&quot;#&quot;&gt;</code>, так и одинокий <code class="match">&lt;b&gt;</code>.</p>
</div></article></div><div class="page__nav-wrap"><a class="page__nav page__nav_prev" href="regexp-lookahead.html" data-tooltip="Предпросмотр (неготово)"><span class="page__nav-text"><span class="page__nav-text-shortcut"></span></span><span class="page__nav-text-alternate">Предыдущий урок</span></a><a class="page__nav page__nav_next" href="extra.html" data-tooltip="О всякой всячине"><span class="page__nav-text"><span class="page__nav-text-shortcut"></span></span><span class="page__nav-text-alternate">Следующий урок</span></a></div><div class="article-tablet-foot tablet-only"><div class="article-tablet-foot__layout"><div class="share-icons"><span class="share-icons__title">Поделиться</span><a class="share share_tw" href="https://twitter.com/share?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_fb" href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_gp" href="https://plus.google.com/share?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_vk" href="https://vkontakte.ru/share.php?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a></div><div class="article-tablet-foot__map"><a class="map" href="tutorial/map.html" data-action="tutorial-map"><span class="map__text">Карта учебника</span></a></div></div></div><div class="banner-bottom"><div class="banner-bottom__text">Проводим <a href="courses.1.html">курсы по Javascript и фреймворкам</a>.</div><button class="banner-bottom__close" data-banner-close="Courses" data-banner-close-message="Эта информация больше не будет выводиться." title="не показывать"></button></div><script>"hideBannerCourses"in localStorage||(document.querySelector(".banner-bottom").style.display="flex");</script><div class="comments formatted" id="comments"><div class="comments__header"><h2 class="comments__header-title"><a href="regexp-infinite-backtracking-problem.html#comments" name="comments">Комментарии</a></h2><div class="comments__read-before"><span class="comments__read-before-link">перед тем как писать…</span><div class="comments__read-before-popup"><div class="comments__read-before-popup-i"><ul><li>Приветствуются комментарии, содержащие дополнения и вопросы по статье, и ответы на них.</li><li>Для одной строки кода используйте тег <code>&lt;code&gt;</code>, для нескольких строк кода&nbsp;&mdash; тег <code>&lt;pre&gt;</code>, если больше 10 строк&nbsp;&mdash; ссылку на песочницу (<a href='http://plnkr.co/edit/?p=preview'>plnkr</a>, <a href='http://jsbin.com'>JSBin</a>, <a href='http://codepen.io'>codepen</a>…)</li><li>Если что-то непонятно в статье&nbsp;&mdash; пишите, что именно и с какого места.</li></ul></div></div></div></div></div><div id="disqus_thread"></div><script>var disqus_config = function() { if (!this.page) this.page = {}; Object.assign(this.page, {"url":"https:\/\/learn.javascript.ru\/regexp-infinite-backtracking-problem","identifier":"\/regexp-infinite-backtracking-problem"}); };</script><script>var disqus_shortname = "learnjavascriptru";</script><script>var disqus_enabled = true;</script></main></div><div class="sidebar page__sidebar sidebar sidebar_sticky-footer"><button class="sidebar__toggle" data-sidebar-toggle></button><a class="map" href="tutorial/map.html" data-action="tutorial-map" data-tooltip="Карта учебника"></a><div class="sidebar__inner"><div class="sidebar__content"><div class="sidebar__section"><h4 class="sidebar__section-title">Раздел</h4><nav class="sidebar__navigation"><ul class="sidebar__navigation-links"><li class="sidebar__navigation-link"><a class="sidebar__link" href="regular-expressions-javascript.html">Регулярные выражения</a></li></ul></nav></div><div class="sidebar__section"><h4 class="sidebar__section-title">Навигация по уроку</h4><nav class="sidebar__navigation"><ul class="sidebar__navigation-links"><li class="sidebar__navigation-link"><a class="sidebar__link" href="regexp-infinite-backtracking-problem.html#primer">Пример</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="regexp-infinite-backtracking-problem.html#bektreking">Бектрекинг</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="regexp-infinite-backtracking-problem.html#chto-delat">Что делать?</a></li></ul></nav></div><div class="sidebar__section"><nav class="sidebar__navigation"><ul class="sidebar__navigation-links"><li class="sidebar__navigation-link"><a class="sidebar__link" href="regexp-infinite-backtracking-problem.html#comments">Комментарии</a></li></ul></nav></div><div class="sidebar__section"><div class="sidebar__section-title">Поделиться</div><a class="share share_tw sidebar__share" href="https://twitter.com/share?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_fb sidebar__share" href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p[url]=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_gp sidebar__share" href="https://plus.google.com/share?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a><a class="share share_vk sidebar__share" href="https://vkontakte.ru/share.php?url=http%3A%2F%2Flearn.javascript.ru%2Fregexp-infinite-backtracking-problem"></a></div><div class="sidebar__section"><a class="sidebar__link" href="https://github.com/iliakan/javascript-tutorial-ru/blob/master/10-regular-expressions-javascript/13-regexp-infinite-backtracking-problem/article.md">Редактировать на Github</a></div></div></div></div></div></div><div class="page-footer"><div class="page-footer__left"><ul class="page-footer__list"><li class="page-footer__item">©&nbsp;2007—2018&nbsp; Илья Кантор</li><li class="page-footer__item"><a class="page-footer__link" href="about.html#contact-us">связаться с нами</a></li><li class="page-footer__item"><a class="page-footer__link" href="terms.html">пользовательское соглашение</a></li><li class="page-footer__item"><a class="page-footer__link" href="privacy.html">политика конфиденциальности</a></li><li class="page-footer__item"><a class="page-footer__slack" href="http://slack.javascript.ru">slack-чат</a></li><li class="page-footer__item"><a class="page-footer__link" href="about.html">о проекте</a></li></ul></div><div class="page-footer__right"><ul class="page-footer__list"><li><a class="page-footer__link" rel="nofollow" href="http://github.com/iliakan/javascript-tutorial-ru">open source</a></li></ul></div></div></body></html>